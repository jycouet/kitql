import { Callout } from '@theguild/components'

# âš¡KitQL

We make use of amazing Open Source projects:

- [Yoga](https://www.graphql-yoga.com/)
- [Code Generator](https://www.graphql-code-generator.com/)
- [Modules](https://www.graphql-modules.com/)
- [Envelop](https://www.envelop.dev/)

## Configuration

### Hooks

The idea is to bring functionalities with hooks, something like:

```ts filename="hooks.server.ts"
import { dev } from '$app/environment'
import { kitqlServer } from '$lib/graphql/kitQLServer'
import { handleGraphiql, handleGraphql } from '@kitql/all-in'
import { sequence } from '@sveltejs/kit/hooks'

export const handle = sequence(
  // Add graphql
  handleGraphql(kitqlServer),

  // Add graphiql
  handleGraphiql({
    enabled: dev
  })
)
```

_You could use only `graphiql` here for example!_

> Side note: if you want **offline support** for _graphiql_, add `@graphql-yoga/render-graphiql` as dependency, KitQL will pick it up automatically if it's there

Now, let's build the `kitqlServer` const ðŸ‘‡

### `kitqlServer`

This is the file where you will create your kitQL Server. To start, it should look like:

```ts
import type { RequestEvent } from '@sveltejs/kit'
import { kitQLModules } from './kitQLModules'
// This should be fully generated ðŸ¥³
import { modules } from './$kitql/_appModules'

const plugins = []
plugins.push(kitQLModules(modules))

function getContext({ request }: RequestEvent) {
  // get the cookie or the token...
  const coolInfo = request.headers.get('Authorization')

  // get the user from the coolInfo (redis or db)
  const user = { id: 1, name: 'John' }

  return {
    request,
    user
  }
}

// Option 1 => explicitly set the context type
// export type IKitQLContext = {
//   request: Request
//   user?: {
//     id: number
//     name: string
//   }
// }
// Option 2 => build IKitQLContext from getContext return
export type IKitQLContext = ReturnType<typeof getContext>

// then, make use of "IKitQLContext" in code gen, generate resolvers fully typed!
// config:
//   contextType: $graphql/kitQLServer#IKitQLContext

export const kitqlServer = {
  plugins,
  getContext
}
```

Now, we just need to generate everything... to have typings & modules.

### Generators

#### Type-codegen

Create a config file `.graphqlrc.yaml` with the following content:

```yaml filename=".graphqlrc.yaml"
projects:
  # You can add multiple projects and generate with -p args
  default:
    # ðŸ‘‡ For vscode-graphql and intellisense
    schema:
      - ./src/lib/modules/**/typedefs/*.graphql
      - ./$houdini/graphql/schema.graphql
    documents:
      - ./src/lib/modules/**/graphql/*.gql
      - ./$houdini/graphql/documents.gql

    # ðŸ‘‡ For code generation
    extensions:
      codegen:
        generates:
          ./src/lib/graphql/$kitql/graphqlTypes.ts:
            plugins:
              - typescript

          ./src/lib/modules/:
            preset: graphql-modules
            presetConfig:
              baseTypesPath: ../graphql/$kitql/graphqlTypes.ts
              importBaseTypesFrom: $graphql/$kitql/graphqlTypes
              filename: $kitql/moduleTypes.ts
            plugins:
              - typescript
              - typescript-resolvers
            config:
              contextType: $graphql/kitQLServer#IKitQLContext
              useTypeImports: true
```

#### Module-codegen

Create a config file `.kitql.yaml` with the following content:

```yaml filename=".kitql.yaml"
generates:
  ./src/lib/graphql/$kitql:
    modules:
      - ./src/lib/modules/*
    actions:
      # createEnumsModule:
      #   prismaFile: ./prisma/schema.prisma
      mergeModuleTypedefs: true
      mergeModuleResolvers: true
      mergeContexts: true
      mergeModules: true

    moduleOutputFolder: $kitql
    importBaseTypesFrom: $graphql/$kitql/graphqlTypes
```

<Callout>We will probably move this somewhere else! (Vite Plugin?! Come and motivate us ðŸ˜…)</Callout>

#### Package scripts

Update your `gen` script so that we generate `modules`, `houdini` and `codegen`.

```json {4-7} filename="package.json"
{
  // ...
  "scripts": {
    "prepare": "svelte-kit sync && npm run gen",
    "gen": "npm run gen:modules && npm run gen:types",
    "gen:modules": "node ./node_modules/@kitql/module-codegen/index.js",
    "gen:types": "graphql-codegen --config ./.graphqlrc.yaml"
  }
  // ...
}
```

Go back to [Get Started](/docs/all-in).
